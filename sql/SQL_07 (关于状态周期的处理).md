
钢铁烧炉一个周期为烧炉->烧炉后换炉->送风->送风后换炉（一个周期大概3个小时）
烧炉:        **sl_type='True' 	   sf_state='False'**
烧炉后换炉:   **sl_type='False' 	sf_state='False'**
送风:         **sl_type='False' 	sf_state='True'**
送风后换炉:   **sl_type='False' 	sf_state='False'**
一天有若干个周期，给一天的数据划分周期，并计算出每个周期的内的烧炉，换炉，送风，
换炉的开始时间和结束时间以及持续时长（单位分钟保留两位小数）。
关于跨天的周期要把昨天的半个周期包含在下一天的第一个周期中，当天的最后半个周期移到明天的第一个周期。
sql_stove_01s表的数据为每秒一条，可能一天会丢失几百条，不影响计算。
编写sql计算出'2022-11-17'分区下的结果表。


```sql

--Impala
--DDL:
CREATE TABLE IF NOT EXISTS stove_status
(
	stove_timestamp string comment '时间（PK）'，
	sl_type string comment '烧炉状态' ,
    sf_state string comment '送风状态'
)
PARTITIONED BY (ds string comment '日期：yyyy-MM-dd')
STORED AS PARQUET 
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\u0001';


```



**示例：**

````shell

stove_status 表：
+-----------------------+-------------+-------------+-------------+
|   stove_timestamp     |  sl_type    |  sf_state   |      ds     |
+-----------------------+-------------+-------------+-------------+
|  2022-11-17 00:00:00  |    True     |    False    | 2022-11-17  |
|  2022-11-17 00:00:01  |    True     |    False    | 2022-11-17  |
|  2022-11-17 00:00:02  |    True     |    False    | 2022-11-17  |
|  2022-11-17 00:00:03  |    True     |    False    | 2022-11-17  |
|  2022-11-17 00:00:04  |    True     |    False    | 2022-11-17  |
|  2022-11-17 00:00:05  |    True     |    False    | 2022-11-17  |
|  2022-11-17 00:00:06  |    True     |    False    | 2022-11-17  |
|  2022-11-17 00:00:07  |    True     |    False    | 2022-11-17  |
|  2022-11-17 00:00:08  |    True     |    False    | 2022-11-17  |
|  2022-11-17 00:00:09  |    True     |    False    | 2022-11-17  |
|  2022-11-17 00:00:10  |    True     |    False    | 2022-11-17  |
|  2022-11-17 00:00:11  |    True     |    False    | 2022-11-17  |
|  2022-11-17 00:00:12  |    True     |    False    | 2022-11-17  |
|  2022-11-17 00:00:13  |    True     |    False    | 2022-11-17  |
|  2022-11-17 00:00:14  |    True     |    False    | 2022-11-17  |
|          ...          |     ...     |     ...     |     ...     |
+-----------------------+-------------+-------------+-------------+

Result 表：
+-------------+---------------------+-----------------------+--------------+--------+
| sl_zt       |       start_time    |        end_time       | sustain_time | period |
+-------------+---------------------+-----------------------+--------------+--------+
| 烧炉        | 2022-11-16 23:34:45 | 2022-11-17 01:19:46   | 105.02       | 1      |
| 烧炉后换炉  | 2022-11-17 01:19:47 | 2022-11-17 01:30:46   | 10.98        | 1      |
| 送风        | 2022-11-17 01:30:47 | 2022-11-17 02:34:44   | 63.95        | 1      |
| 送风后换炉  | 2022-11-17 02:34:45 | 2022-11-17 02:36:54   | 2.15         | 1      |
| 烧炉        | 2022-11-17 02:36:55 | 2022-11-17 04:21:50   | 104.92       | 2      |
| 烧炉后换炉  | 2022-11-17 04:21:51 | 2022-11-17 04:31:20   | 9.48         | 2      |
| 送风        | 2022-11-17 04:31:21 | 2022-11-17 05:32:56   | 61.58        | 2      |
| 送风后换炉  | 2022-11-17 05:32:57 | 2022-11-17 05:35:16   | 2.32         | 2      |
| 烧炉        | 2022-11-17 05:35:17 | 2022-11-17 07:20:50   | 105.55       | 3      |
| 烧炉后换炉  | 2022-11-17 07:20:51 | 2022-11-17 07:30:48   | 9.95         | 3      |
| 送风        | 2022-11-17 07:30:49 | 2022-11-17 08:37:37   | 66.8         | 3      |
| 送风后换炉  | 2022-11-17 08:37:38 | 2022-11-17 08:39:42   | 2.07         | 3      |
| 烧炉        | 2022-11-17 08:39:43 | 2022-11-17 10:19:30   | 99.78        | 4      |
| 烧炉后换炉  | 2022-11-17 10:19:31 | 2022-11-17 10:29:44   | 10.22        | 4      |
| 送风        | 2022-11-17 10:29:45 | 2022-11-17 11:34:07   | 64.37        | 4      |
| 送风后换炉  | 2022-11-17 11:34:09 | 2022-11-17 11:36:20   | 2.18         | 4      |
| 烧炉        | 2022-11-17 11:36:21 | 2022-11-17 13:19:20   | 102.98       | 5      |
| 烧炉后换炉  | 2022-11-17 13:19:21 | 2022-11-17 13:29:28   | 10.12        | 5      |
| 送风        | 2022-11-17 13:29:29 | 2022-11-17 14:35:38   | 66.15        | 5      |
| 送风后换炉  | 2022-11-17 14:35:39 | 2022-11-17 14:37:44   | 2.08         | 5      |
| 烧炉        | 2022-11-17 14:37:45 | 2022-11-17 15:37:04   | 59.32        | 6      |
| 烧炉后换炉  | 2022-11-17 15:37:05 | 2022-11-17 15:38:16   | 1.18         | 6      |
| 送风        | 2022-11-17 15:38:17 | 2022-11-17 16:19:12   | 40.92        | 6      |
| 送风后换炉  | 2022-11-17 16:19:13 | 2022-11-17 16:29:20   | 10.12        | 6      |
| 烧炉        | 2022-11-17 16:29:21 | 2022-11-17 17:33:46   | 64.42        | 7      |
| 烧炉后换炉  | 2022-11-17 17:33:47 | 2022-11-17 17:35:52   | 2.08         | 7      |
| 送风        | 2022-11-17 17:35:53 | 2022-11-17 19:19:13   | 103.33       | 7      |
| 送风后换炉  | 2022-11-17 19:19:14 | 2022-11-17 19:30:06   | 10.87        | 7      |
| 烧炉        | 2022-11-17 19:30:07 | 2022-11-17 20:28:34   | 58.45        | 8      |
| 烧炉后换炉  | 2022-11-17 20:28:35 | 2022-11-17 20:30:36   | 2.02         | 8      |
| 送风        | 2022-11-17 20:30:37 | 2022-11-17 22:19:06   | 108.48       | 8      |
| 送风后换炉  | 2022-11-17 22:19:07 | 2022-11-17 22:29:56   | 10.82        | 8      |
+-------------+---------------------+-----------------------+--------------+--------+
````







<details >
  <summary> ✨ Click to show  the sql    </summary>

````sql

-- impala 
with  t1 as 
(
select
    stove_timestamp ,
    case when sl_type = 'True'  and SF_STATE = 'False' then 1
         when sl_type = 'False' and SF_STATE = 'False' then 2
         when sl_type = 'False' and SF_STATE = 'True'  then 3
    end as type
from stove_status
where ds in ( '2022-11-27' ,'2022-11-26') -- T-1 & T-2
)
,  t2 as 
(
select
    stove_timestamp,
    type ,
    sum(if(type = lag(type,1,0) over (order by stove_timestamp ) ,0,1)) over(order by stove_timestamp )  sum_flag
from 
 (
     select
         stove_timestamp,
         if(last_value(if(type=2,null,type),true ) over(order by stove_timestamp ) <= type,type,4) type
     from t1
 ) a 
)
t3 as 
(   select 
        sl_zt,
		start_time,
		end_time,
		sustain_time,
		period,
		max(end_time) over(partition by period order by end_time) max_flag_time
	from 
	(
	    select 
            case type
                when 1 then '烧炉'
                when 2 then '烧炉后换炉'
                when 3 then '送风'
                when 4 then '送风后换炉'
            end as sl_zt,
            min(stove_timestamp) as start_time ,
            max(stove_timestamp) as end_time,
            cast(to_unix_timestamp(max(stove_timestamp)) - to_unix_timestamp(min(stove_timestamp))/60  as decimal(10,2))  sustain_time ,
    	    ((sum_flag-1) div 4 )  as period 
        from t2
        group by sum_flag,type
	) aaa 

)
select 
    sl_zt,
    start_time,
    end_time,
    sustain_time,
    row_number() over(order by period) period
from t3
 where substr(max_flag_time,1,10) = '2022-11-27';


````

</details>

***
